UseCASE to add a new column based on some conditions
Use window functions such as DENSE_RANK(), SUM()
Simplify the code with CTE
